name: Xiaomi R4A Build (Auto)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 16 * * *'  # æ¯å¤© 00:00ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ§¹ æ¸…ç†ç©ºé—´
      run: |
        sudo rm -rf /opt/* /usr/local/* /etc/* /var/* /home/* || true
        docker rmi $(docker images -q) || true

    - name: ğŸ“¥ å…‹éš†å½“å‰ä»“åº“
      uses: actions/checkout@v3

    - name: ğŸ’¾ ç¼“å­˜ OpenWrt ä¸‹è½½åŒ…
      uses: actions/cache@v3
      with:
        path: openwrt-dl
        key: ${{ runner.os }}-openwrt-dl

    - name: ğŸ“ åˆ›å»ºå¹¶é“¾æ¥ dl ç¼“å­˜ç›®å½•
      run: |
        mkdir -p openwrt-dl
        ln -sf ../openwrt-dl openwrt-src/dl

    - name: ğŸ§¼ æ¸…ç† openwrt-src ç›®å½•ï¼ˆé˜²æ­¢ clone å†²çªï¼‰
      run: rm -rf openwrt-src

    - name: ğŸ“¦ è·å– OpenWrt æºç ï¼ˆä½¿ç”¨å®˜æ–¹æº + ç§»é™¤ videoï¼‰
      run: |
        git clone --depth=1 https://github.com/openwrt/openwrt openwrt-src
        cd openwrt-src
        rm -rf package/kernel/linux/modules/video.mk

    - name: ğŸ§© æ‰§è¡Œå®šåˆ¶è„šæœ¬ï¼ˆä¿®æ”¹åå°åœ°å€ç­‰ï¼‰
      run: |
        chmod +x ./customize.sh
        ./customize.sh

    - name: ğŸ”§ æ³¨å…¥ LuCI æ’ä»¶é…ç½®
      run: |
        cp -f ./feeds.conf.default openwrt-src/feeds.conf.default
        cp -f ./diy/luci-apps.mk openwrt-src/package/lean/luci-apps.mk

    - name: âš™ï¸ æ›¿æ¢é…ç½®æ–‡ä»¶
      run: |
        cp -f .config openwrt-src/.config

    - name: ğŸ› ï¸ ç¼–è¯‘å›ºä»¶ï¼ˆå«è¯¦ç»†æ—¥å¿—ï¼‰
      run: |
        cd openwrt-src
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        make defconfig
        make -j$(nproc) download
        make -j$(nproc) V=s

    - name: ğŸ“¦ æ‰“åŒ…å›ºä»¶ä¸º ZIP
      run: |
        cd openwrt-src/bin/targets/*/*
        zip -r firmware.zip *

    - name: ğŸ“¤ ä¸Šä¼ å›ºä»¶ä¸ºæ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: firmware
        path: openwrt-src/bin/targets/*/*/firmware.zip
