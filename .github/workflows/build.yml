name: Xiaomi R4A Build (Auto)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ§¹ æ¸…ç†ç©ºé—´
      run: |
        sudo rm -rf /opt/*
        df -h

    - name: ğŸ“¥ å…‹éš†å½“å‰ä»“åº“
      uses: actions/checkout@v3

    - name: ğŸ’¾ ç¼“å­˜ OpenWrt ä¸‹è½½åŒ…
      uses: actions/cache@v3
      with:
        path: openwrt/dl
        key: ${{ runner.os }}-openwrt-dl-${{ hashFiles('.config') }}
        restore-keys: |
          ${{ runner.os }}-openwrt-dl-

    - name: ğŸ§¼ æ¸…ç† openwrt ç›®å½•ï¼ˆé˜²æ­¢ clone å†²çªï¼‰
      run: rm -rf openwrt

    - name: ğŸ“¦ è·å– OpenWrt æºç 
      run: |
        git clone --depth=1 https://github.com/openwrt/openwrt openwrt
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: ğŸ§© æ‰§è¡Œå®šåˆ¶è„šæœ¬
      run: |
        chmod +x scripts/*.sh
        ./scripts/diy-part1.sh
        ./scripts/diy-part2.sh

    - name: âš™ï¸ æ›¿æ¢é…ç½®æ–‡ä»¶
      run: |
        cp .config openwrt/.config

    - name: ğŸ¯ è®¾ç½®ç›®æ ‡è®¾å¤‡ä¸º R4A v2
      run: |
        sed -i 's/CONFIG_TARGET_ramips_mt7621_DEVICE_xiaomi_mi-router-4a-gigabit=y/CONFIG_TARGET_ramips_mt7621_DEVICE_xiaomi_mi-router-4a-gigabit-v2=y/' openwrt/.config

    - name: ğŸ”Œ æ³¨å…¥ LuCI æ’ä»¶é…ç½®
      run: |
        echo "CONFIG_PACKAGE_luci=y" >> openwrt/.config
        echo "CONFIG_PACKAGE_luci-ssl=y" >> openwrt/.config
        echo "CONFIG_PACKAGE_luci-app-upnp=y" >> openwrt/.config
        echo "CONFIG_PACKAGE_luci-app-ddns=y" >> openwrt/.config
        echo "CONFIG_PACKAGE_luci-app-wol=y" >> openwrt/.config

    - name: ğŸ“„ æ˜¾ç¤ºæœ€ç»ˆé…ç½®
      run: |
        cd openwrt
        echo "ğŸ¯ Target Profile:"
        grep CONFIG_TARGET .config | grep '=y'
        echo "ğŸ”Œ LuCI Plugins:"
        grep CONFIG_PACKAGE_luci .config | grep '=y'

    - name: ğŸ› ï¸ ç¼–è¯‘å›ºä»¶
      run: |
        cd openwrt
        make defconfig
        make -j$(nproc) download
        make -j$(nproc)

    - name: ğŸ“¦ æ‰“åŒ…å›ºä»¶ä¸º ZIPï¼ˆå¸¦æ—¥æœŸï¼‰
      run: |
        cd openwrt/bin/targets/
        zip -r "firmware-$(date -u -d '8 hours' +'%Y%m%d').zip" ./

    - name: ğŸ“¤ ä¸Šä¼ å›ºä»¶ä¸ºæ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: openwrt/bin/targets/firmware-*.zip
